<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Bitvoker UI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #141421;
      color: #ffffff;
      font-weight: 500;
    }
    .card {
      background-color: #1f1f38;
      border: 1px solid #1abc9c;
      border-radius: 5px;
      margin-bottom: 1rem;
    }
    .card-header, .card-body, .nav-tabs .nav-link, .tab-pane, label, input, select, button, textarea {
      color: #ffffff !important;
      font-weight: 500;
    }
    .nav-tabs .nav-link {
      color: #ffffff !important;
    }
    .nav-tabs .nav-link.active {
      background-color: #1f1f38;
    }
    .form-control, .form-check-input, select, textarea {
      background-color: #1f1f38;
      color: #ffffff !important;
      border: 1px solid #7f8c8d;
      font-weight: 500;
    }
    .form-control:focus, textarea:focus {
      background-color: #1f1f38;
      color: #ffffff !important;
      border-color: #1abc9c !important;
      box-shadow: 0 0 0 0.2rem rgba(26,188,156,0.25);
    }
    a { color: #ffffff !important; }
    .form-text {
      color: #bdc3c7 !important;
    }
    .input-inline label {
      margin-right: 0.5rem;
      margin-bottom: 0;
    }
    .input-inline input, .input-inline select {
      display: inline-block;
      width: auto;
      vertical-align: middle;
      margin-right: 0.5rem;
    }
    .input-inline button {
      vertical-align: middle;
    }
    #logs-content {
      border: 1px solid #1abc9c;
      padding: 10px;
      border-radius: 5px;
      max-height: 24em;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">Notifications</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">Settings</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">Logs</button>
    </li>
  </ul>
  <div class="tab-content mt-3" id="myTabContent">
    <!-- Notifications Tab -->
    <div class="tab-pane fade show active" id="notifications" role="tabpanel">
      <div class="input-inline mb-3">
        <label for="limit">Limit:</label>
        <input type="number" id="limit" class="form-control me-3" style="width:80px;" value="20" onchange="fetchNotifications()">
        <label for="date_filter">Date:</label>
        <input type="date" id="date_filter" class="form-control me-3" style="width:180px;" onchange="fetchNotifications()">
        <button class="btn btn-secondary" onclick="fetchNotifications()">Filter</button>
      </div>
      <div id="notifications-content"></div>
    </div>
    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
      <form method="post" action="{{ url_for('index') }}">
        <!-- Row 1: Telegram Credentials -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="bot_token" class="form-label">Telegram Bot Token</label>
            <div class="input-group">
              <input type="password" class="form-control" id="bot_token" name="bot_token" value="{{ config.bot_token }}">
              <button class="btn btn-outline-secondary" type="button"
                      onmousedown="toggleSecret('bot_token', true)"
                      onmouseup="toggleSecret('bot_token', false)"
                      onmouseleave="toggleSecret('bot_token', false)">
                üëÅ
              </button>
            </div>
            <div class="form-text">
              Obtain your token from <a href="https://telegram.me/BotFather" target="_blank" class="text-white">BotFather</a>.
            </div>
          </div>
          <div class="col-md-6">
            <label for="chat_id" class="form-label">Telegram Chat ID</label>
            <div class="input-group">
              <input type="password" class="form-control" id="chat_id" name="chat_id" value="{{ config.chat_id }}">
              <button class="btn btn-outline-secondary" type="button"
                      onmousedown="toggleSecret('chat_id', true)"
                      onmouseup="toggleSecret('chat_id', false)"
                      onmouseleave="toggleSecret('chat_id', false)">
                üëÅ
              </button>
            </div>
            <div class="form-text">
              Use the @getidsbot within the chat you started after creating your bot.
            </div>
          </div>
        </div>
        <!-- Row 2: Server Options and Toggles -->
        <div class="row mb-3 align-items-center">
          <div class="col-md-3">
            <label for="server_host" class="form-label">Server Host</label>
            <input type="text" class="form-control" id="server_host" name="server_host" value="{{ config.server_host }}">
            <div class="form-text">Hostname or IP.</div>
          </div>
          <div class="col-md-3">
            <label for="server_port" class="form-label">Server Port</label>
            <input type="number" class="form-control" id="server_port" name="server_port" value="{{ config.server_port }}">
            <div class="form-text">TCP port for the server.</div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="enable_ai" name="enable_ai" {% if config.enable_ai %}checked{% endif %}>
              <label class="form-check-label" for="enable_ai">Enable AI</label>
            </div>
            <div class="form-text">Toggle message processing via AI.</div>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="show_original" name="show_original" {% if config.show_original %}checked{% endif %}>
              <label class="form-check-label" for="show_original">Show Original Message</label>
            </div>
            <div class="form-text">Display raw messages alongside AI summary.</div>
          </div>
        </div>
        <!-- Row 3: Preprompt -->
        <div class="mb-3">
          <label for="preprompt" class="form-label">Preprompt (max 2048 characters)</label>
          <textarea class="form-control" id="preprompt" name="preprompt" maxlength="2048" rows="5">{{ config.preprompt }}</textarea>
          <div class="form-text">Default prompt prepended to messages. If left empty, AI will be disabled.</div>
        </div>
        <button type="submit" class="btn btn-primary">Save Settings</button>
      </form>
    </div>
    <!-- Logs Tab -->
    <div class="tab-pane fade" id="logs" role="tabpanel">
      <div class="input-inline mb-3">
        <label for="log_level_filter">Log Level:</label>
        <select id="log_level_filter" class="form-control me-3" style="width:120px;" onchange="fetchLogs()">
          <option value="ALL">ALL</option>
          <option value="DEBUG">DEBUG</option>
          <option value="INFO" selected>INFO</option>
          <option value="WARNING">WARNING</option>
          <option value="ERROR">ERROR</option>
        </select>
        <button class="btn btn-secondary" onclick="fetchLogs()">Filter</button>
      </div>
      <div id="logs-content"></div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function toggleSecret(fieldId, show) {
    var input = document.getElementById(fieldId);
    input.type = show ? 'text' : 'password';
  }
  function fetchNotifications() {
    const limit = document.getElementById('limit').value || 20;
    const date_filter = document.getElementById('date_filter').value || "";
    fetch(`/get_notifications?limit=${limit}&date=${date_filter}`)
      .then(response => response.json())
      .then(data => {
        let content = '';
        if(data.notifications.length === 0) {
          content = `<div class="alert alert-info">No notifications yet. Get started by sending a message to the TCP server using a tool like telnet or your own client at the specified host and port in your settings.</div>`;
        } else {
          data.notifications.forEach(nt => {
            content += `<div class="card">
              <div class="card-header">${nt.timestamp} | From: ${nt.client}</div>
              <div class="card-body">
                <h5 class="card-title">Original Message</h5>
                <p class="card-text">${nt.original}</p>`;
            if(nt.ai) {
              content += `<hr>
                          <h6 class="card-subtitle mb-2">AI Summary</h6>
                          <p class="card-text">${nt.ai}</p>`;
            }
            content += `</div></div>`;
          });
        }
        document.getElementById('notifications-content').innerHTML = content;
      });
  }
  function fetchLogs() {
    const selectedLevel = document.getElementById('log_level_filter').value;
    const levelMapping = { "DEBUG": 10, "INFO": 20, "WARNING": 30, "ERROR": 40, "CRITICAL": 50 };
    fetch('/get_logs')
      .then(response => response.json())
      .then(data => {
        let content = '';
        data.logs.forEach(log => {
          if(selectedLevel === "ALL" || levelMapping[log.level] >= levelMapping[selectedLevel]) {
            content += `<div>${log.timestamp} - ${log.level} - ${log.message}</div>`;
          }
        });
        document.getElementById('logs-content').innerHTML = content;
      });
  }
  setInterval(fetchNotifications, 2000);
  setInterval(fetchLogs, 2000);
  fetchNotifications();
  fetchLogs();
</script>
</body>
</html>
